<!DOCTYPE html>
<!--[if lt IE 7]>
<html class="no-js ie6 oldie" lang="en"></html>
<![endif]--><!--[if IE 7]>
<html class="no-js ie7 oldie" lang="en"></html>
<![endif]--><!--[if IE 8]>
<html class="no-js ie8 oldie" lang="en"></html>
<![endif]--><!--[if gte IE 8]>
<html class="no-js" lang="en"></html>
<![endif]-->
<head>
  <title>Kale Krate</title><meta charset="utf-8" />
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
  <meta content="" name="description" />
  <meta content="" name="author" />
  <meta content="" name="keywords" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" /><script src="https://js.recurly.com/v3/recurly.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <link href="//fonts.googleapis.com/css?family=Open+Sans:400,700,600" rel="stylesheet" type="text/css" /><link rel='stylesheet' href='/css/application.c508c4b0605a2fa9d4b246f28ae9134c.css' /><link rel='stylesheet' href='/css/advanced.b8a8f690c88d6ce4ad35233d6fd569ef.css' />
</head>
<body>
  <div class="form">
    <div class="form-bar">
      <div class="subscription-name-container">
        <strong class="subscription-name">Kale Lover's Crate</strong>
      </div>
      <div class="subscription-pricing-container">
        <div class="subscription-pricing">
          <span class="subscription-price">$20.99</span><span class="subscription-frequency"></span>/month
        </div>
      </div>
    </div>
    <div class="confirmation">
      <div class="confirmation-body">
        <h2 class="confirmation-messaging">
          Thank you for subscribing!
        </h2>
      </div>
    </div>
    <form action="/api/subscriptions/new" method="post">
      <input data-recurly="token" name="recurly-token" type="hidden" />
      <div class="row">
        <div class="form-errors form-errors__hidden">
          <strong>Oops! The following fields appear to be invalid:</strong>
          <ul></ul>
        </div>
      </div>
      <div class="row customer-fields--name">
        <div class="form-input">
          <label for="first_name">First Name</label><input data-recurly="first_name" id="first_name" name="first-name" type="text" />
        </div>
        <div class="form-input">
          <label for="last_name">Last Name</label><input data-recurly="last_name" id="last_name" name="last-name" type="text" />
        </div>
      </div>
      <div class="row customer-fields--email">
        <div class="form-input">
          <label for="email">Email</label><input data-recurly="email" id="email" name="email" type="text" />
        </div>
      </div>
      <div class="row customer-fields--card-number">
        <div class="form-input">
          <label for="number">Credit Card Number</label><input data-recurly="number" id="number" name="number" type="text" /><span class="icon icon-card icon-card__generic"></span><span class="icon icon-lock"></span>
        </div>
      </div>
      <div class="row customer-fields--card-details">
        <div class="form-input form-input__selection customer-fields--card-expiry">
          <label for="month">Expiration</label><input data-recurly="month" id="month" maxlength="2" name="month" placeholder="MM" type="text" /><input data-recurly="year" id="year" maxlength="2" name="year" placeholder="YY" type="text" />
        </div>
        <div class="form-input customer-fields--card-cvv">
          <label for="cvv">CVC</label><input data-recurly="cvv" id="cvv" name="cvv" type="text" />
        </div>
      </div>
      <div class="row customer-fields--address">
        <div class="form-input">
          <label for="address">Address</label><input data-recurly="address" id="address" name="address" type="text" />
        </div>
      </div>
      <div class="row customer-fields--city">
        <div class="form-input">
          <label for="city">City</label><input data-recurly="city" id="city" name="city" type="text" />
        </div>
        <div class="form-input customer-fields--card-cvv">
          <label for="postal_code">Zip</label><input data-recurly="postal_code" id="postal_code" name="postal-code" type="text" />
        </div>
      </div>
      <div class="row">
        <div class="form-input">
          <label for="postal_code">Country</label><select id="country" name="country"><option value="AL">Alabama</option>
            <option value="AK">Alaska</option>
            <option value="AZ">Arizona</option>
            <option value="AR">Arkansas</option>
            <option value="CA">California</option>
            <option value="CO">Colorado</option>
            <option value="CT">Connecticut</option>
            <option value="DE">Delaware</option>
            <option value="FL">Florida</option>
            <option value="GA">Georgia</option>
            <option value="HI">Hawaii</option>
            <option value="ID">Idaho</option>
            <option value="IL">Illinois</option>
            <option value="IN">Indiana</option>
            <option value="IA">Iowa</option>
            <option value="KS">Kansas</option>
            <option value="KY">Kentucky</option>
            <option value="LA">Louisiana</option>
            <option value="ME">Maine</option>
            <option value="MD">Maryland</option>
            <option value="MA">Massachusetts</option>
            <option value="MI">Michigan</option>
            <option value="MN">Minnesota</option>
            <option value="MS">Mississippi</option>
            <option value="MO">Missouri</option>
            <option value="MT">Montana</option>
            <option value="NE">Nebraska</option>
            <option value="NV">Nevada</option>
            <option value="NH">New Hampshire</option>
            <option value="NJ">New Jersey</option>
            <option value="NM">New Mexico</option>
            <option value="NY">New York</option>
            <option value="NC">North Carolina</option>
            <option value="ND">North Dakota</option>
            <option value="OH">Ohio</option>
            <option value="OK">Oklahoma</option>
            <option value="OR">Oregon</option>
            <option value="PA">Pennsylvania</option>
            <option value="RI">Rhode Island</option>
            <option value="SC">South Carolina</option>
            <option value="SD">South Dakota</option>
            <option value="TN">Tennessee</option>
            <option value="TX">Texas</option>
            <option value="UT">Utah</option>
            <option value="VT">Vermont</option>
            <option value="VA">Virginia</option>
            <option value="WA">Washington</option>
            <option value="WV">West Virginia</option>
            <option value="WI">Wisconsin</option>
            <option value="WY">Wyoming</option></select>
        </div>
      </div>
      <div class="row">
        <input class="btn-submit" id="subscribe" type="submit" value="Subscribe" />
      </div>
    </form>
  </div>
</body>
<script type="text/javascript">
  var error_fields = {
    first_name: 'First name',
    last_name: 'Last name',
    email: 'Email address',
    number: 'Credit Card number',
    postal_code: 'Postal Code',
    month: 'Expiration Month',
    year: 'Expiration Year'
  }
  
  // Configure recurly.js
  //recurly.configure('sc-Hw20ERMh8bzGFiWKO7NvDB');
  recurly.configure('9bed482cacae41748f405c2d361fdc6a');
  
  
  // On form submit, we stop submission to go get the token
  $('form').on('submit', function (event) {
    event.preventDefault();
  
    // Reset the errors display
    $('#errors').text('');
    $('input').removeClass('error');
  
    // Disable the submit button
    $('.btn-submit').prop('disabled', true);
  
    var form = this;
  
    // Now we call recurly.token with the form. It goes to Recurly servers
    // to tokenize the credit card information, then injects the token into the
    // data-recurly="token" field above
    recurly.token(form, function (err, token) {
  
      if (err) {
        error(err);
      }
      else {
        var data = {
          "recurly-token": $('input[name="recurly-token"]').val(),
          "first-name": $('input[name="first-name"]').val(),
          "last-name": $('input[name="last-name"]').val(),
          "email": $('input[name="email"]').val()
        };
  
        $.ajax({
          type: "POST",
          url: '/api/subscriptions/new',
          data: data,
          success: subscription_created(data),
          dataType: 'json'
        });
  
      };
  
    });
  
  });
  
  function subscription_created(data) {
    $('form').addClass('form__success');
  
    $('.confirmation').addClass('confirmation__show');
    $('.confirmation-messaging').addClass('animate');
  }
  
  $(document).ready(function() {
  
    // Identity card type
    $("#number").on('change', function(event) {
      var card_number = $("#number").val()
        , card_type = recurly.validate.cardType(card_number)
        , card_is_valid = recurly.validate.cardNumber($("#number").val())
        , number_field = $('.customer-fields--card-number .form-input');
  
      if(card_is_valid) {
        $(number_field).removeClass('form-input__error');
      }
      else {
        $(number_field).addClass('form-input__error');
      }
  
      if(card_type == 'default') {
        $('.icon-card').addClass('icon-card__generic');
      }
      else {
        $('.icon-card').addClass('icon-card__' + card_type);
      }
    });
  
  });
  
  
  // A simple error handling function to expose errors to the customer
  function error (err) {
    var errors_markup = $.map(err.fields, function (field) {
      $('input[data-recurly=' + field + ']').addClass('error');
      return '<li class="form-errors--invalid-field">'+ error_fields[field] +'</li>';
    }).join('');
  
    $('.form-errors').removeClass('form-errors__hidden');
    $('.form-errors ul')
      .empty()
      .append(errors_markup);
  
    $('input[type="submit"]').prop('disabled', false);
    $.each(err.fields, function (i, field) {
      $('[data-recurly=' + field + ']').addClass('error');
    });
  }
</script>